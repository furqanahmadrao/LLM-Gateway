name: PR - Quick Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

jobs:
  quick-checks:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'pnpm'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run build (capture)
        id: run_build
        run: |
          set -euo pipefail
          pnpm --version
          pnpm build > build.log 2>&1 || echo BUILD_FAILED > build.status || true
          echo "build_exit=$(if [ -f build.status ]; then echo 1; else echo 0; fi)" >> $GITHUB_OUTPUT

      - name: Run tests (capture)
        id: run_tests
        run: |
          set -euo pipefail
          pnpm test > test.log 2>&1 || echo TESTS_FAILED > test.status || true
          echo "tests_exit=$(if [ -f test.status ]; then echo 1; else echo 0; fi)" >> $GITHUB_OUTPUT

      - name: Run typecheck (capture)
        id: run_type
        run: |
          set -euo pipefail
          pnpm typecheck > type.log 2>&1 || echo TYPE_FAILED > type.status || true
          echo "type_exit=$(if [ -f type.status ]; then echo 1; else echo 0; fi)" >> $GITHUB_OUTPUT

      - name: Read results and post PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request.number;

            function readSafe(path){ try { return fs.readFileSync(path,'utf8'); } catch(e) { return null; } }

            const buildLog = readSafe('build.log');
            const testLog = readSafe('test.log');
            const typeLog = readSafe('type.log');

            const buildFailed = !!readSafe('build.status');
            const testsFailed = !!readSafe('test.status');
            const typeFailed = !!readSafe('type.status');

            let body = '## PR Quick Check Report\n\n';

            if (!buildFailed && !testsFailed && !typeFailed) {
              body += ':white_check_mark: All quick checks passed (build, tests, typecheck).';
            } else {
              body += ':warning: Some checks failed. Please review the details below and fix issues before the maintainers perform a detailed review.\n\n';
              if (buildFailed) {
                body += '### ❌ Build failed\n';
                body += '<details><summary>View build log</summary>\n\n<pre>' + (buildLog || 'No build log captured') + '</pre>\n</details>\n\n';
              } else {
                body += '### ✅ Build passed\n\n';
              }
              if (testsFailed) {
                body += '### ❌ Tests failed\n';
                body += '<details><summary>View test log</summary>\n\n<pre>' + (testLog || 'No test log captured') + '</pre>\n</details>\n\n';
              } else {
                body += '### ✅ Tests passed\n\n';
              }
              if (typeFailed) {
                body += '### ❌ Typecheck failed\n';
                body += '<details><summary>View typecheck log</summary>\n\n<pre>' + (typeLog || 'No typecheck log captured') + '</pre>\n</details>\n\n';
              } else {
                body += '### ✅ Typecheck passed\n\n';
              }
            }

            body += '\n---\n*This comment was generated by an automated quick-check workflow. Trim logs locally when asking for help.*';

            await github.issues.createComment({ owner, repo, issue_number: pr, body });

            if (buildFailed || testsFailed || typeFailed) {
              try{
                await github.issues.addLabels({ owner, repo, issue_number: pr, labels: ['automated-checks:failed'] });
              }catch(e){ /* ignore */ }
            } else {
              try{
                const labels = await github.issues.listLabelsOnIssue({ owner, repo, issue_number: pr });
                const has = labels.data.find(l => l.name === 'automated-checks:failed');
                if (has) await github.issues.removeLabel({ owner, repo, issue_number: pr, name: 'automated-checks:failed' });
              }catch(e){ /* ignore */ }
            }